# 전자결재 시스템 구현 계획

**최종 수정일**: 2025-08-21  
**변경 이력**: 
- @dataclass에서 Pydantic BaseModel로 변경
- Phase 1, 2 구현 완료
- 템플릿 없이도 결재 요청 생성 가능하도록 수정

**🎉 구현 상태**: Phase 1, 2 완료 - 기본 전자결재 시스템 동작 가능

## 1. 프로젝트 구조 및 아키텍처

### 1.1 기존 시스템 분석
- 현재 시스템: 계층형 아키텍처 (interface → application → domain → infra)
- 기존 엔티티: User, Voucher, File, Group
- 인증/권한: JWT 기반, Role (ADMIN, USER, VOUCHER), ApprovalStatus

### 1.2 새로운 엔티티 추가
```
domain/
├── document_template.py     # 결재 양식 템플릿
├── approval_request.py      # 결재 요청서
├── approval_line.py         # 결재선
├── approval_history.py      # 결재 이력
└── attached_file.py         # 첨부파일 (결재용)
```

## 2. 도메인 모델 설계

### 2.1 DocumentTemplate (결재 양식)
```python
from pydantic import BaseModel, Field, ConfigDict
from typing import Optional, List
from datetime import datetime

class DefaultApprovalStep(BaseModel):
    step_order: int           # 결재 순서
    approver_id: str          # 기본 결재자 ID (또는 직책/부서)
    is_required: bool = True  # 필수 결재 여부
    is_parallel: bool = False # 병렬 결재 여부

class DocumentTemplate(BaseModel):
    id: str
    name: str                    # 양식명 (업무기안, 지출결의서 등)
    description: Optional[str] = None   # 양식 설명
    category: str               # 카테고리 (업무, 지출, 인사 등)
    document_prefix: Optional[str] = None        # 문서번호 프리픽스
    default_approval_steps: List[DefaultApprovalStep] = Field(default_factory=list)  # 기본 결재선
    is_active: bool = True
    created_at: datetime
    updated_at: datetime
    
    model_config = ConfigDict(extra="ignore")
```

### 2.2 ApprovalRequest (결재 요청서)
```python
from common.auth import DocumentVisibility, DocumentStatus

class ApprovalRequest(BaseModel):
    id: str
    template_id: Optional[str] = None    # 사용한 양식 ID (옵셔널 - 템플릿 없이도 생성 가능)
    document_number: str       # 자동 생성 문서번호
    title: str                # 결재 제목
    content: str              # 결재 내용 (HTML)
    form_data: Dict[str, Any] = Field(default_factory=dict) # 양식별 추가 데이터
    requester_id: str         # 기안자 ID
    department_id: Optional[str] = None        # 기안 부서
    visibility: DocumentVisibility  # 공개범위
    status: DocumentStatus    # 결재 상태
    current_step: int = 0         # 현재 결재 단계
    created_at: datetime
    updated_at: datetime
    submitted_at: Optional[datetime] = None
    completed_at: Optional[datetime] = None
    
    model_config = ConfigDict(extra="ignore")
```

### 2.3 ApprovalLine (결재선)
```python
from common.auth import ApprovalStatus

class ApprovalLine(BaseModel):
    id: str
    request_id: str           # 결재 요청 ID
    approver_id: str          # 결재자 ID
    step_order: int           # 결재 순서
    is_required: bool = True         # 필수 결재 여부
    is_parallel: bool = False         # 병렬 결재 여부
    status: ApprovalStatus = ApprovalStatus.PENDING    # 개별 결재 상태
    approved_at: Optional[datetime] = None
    comment: Optional[str] = None    # 결재 의견
    
    model_config = ConfigDict(extra="ignore")
```

### 2.4 ApprovalHistory (결재 이력)
```python
from common.auth import ApprovalAction

class ApprovalHistory(BaseModel):
    id: str
    request_id: str
    approver_id: str
    action: ApprovalAction    # APPROVE, REJECT, CANCEL
    comment: Optional[str] = None
    created_at: datetime
    ip_address: Optional[str] = None
    
    model_config = ConfigDict(extra="ignore")
```

### 2.5 AttachedFile (첨부파일)
```python
class AttachedFile(BaseModel):
    id: str
    request_id: str
    file_name: str
    file_path: str
    file_size: int
    file_type: str
    is_reference: bool = False        # 참조문서 여부
    uploaded_at: datetime
    uploaded_by: str
    
    model_config = ConfigDict(extra="ignore")
```

## 3. Enum 추가 (common/auth.py)

기존 ApprovalStatus 아래에 추가:

```python
class DocumentStatus(StrEnum):
    DRAFT = "DRAFT"                    # 임시저장
    SUBMITTED = "SUBMITTED"            # 상신완료
    IN_PROGRESS = "IN_PROGRESS"        # 결재진행중
    APPROVED = "APPROVED"              # 승인완료
    REJECTED = "REJECTED"              # 반려
    CANCELLED = "CANCELLED"            # 취소

class ApprovalAction(StrEnum):
    APPROVE = "APPROVE"                # 승인
    REJECT = "REJECT"                  # 반려
    CANCEL = "CANCEL"                  # 취소

class DocumentVisibility(StrEnum):
    PUBLIC = "PUBLIC"                  # 전체공개
    PRIVATE = "PRIVATE"                # 비공개
    DEPARTMENT = "DEPARTMENT"          # 부서공개
```

**주의**: 이미 기존 ApprovalStatus가 있으므로 중복되지 않도록 주의

## 4. 데이터베이스 설계

### 4.1 MongoDB 컬렉션 설계
```
collections:
- document_templates     # 결재 양식
- approval_requests      # 결재 요청서
- approval_lines        # 결재선
- approval_histories    # 결재 이력
- attached_files        # 첨부파일
```

### 4.2 DB 모델 파일 구조
```
infra/db_models/
├── document_template.py
├── approval_request.py
├── approval_line.py
├── approval_history.py
└── attached_file.py
```

### 4.3 인덱스 설계
- approval_requests: requester_id, status, created_at
- approval_lines: request_id, approver_id, step_order
- approval_histories: request_id, created_at
- attached_files: request_id

## 5. API 설계

### 5.1 양식 관리 API
```
GET    /api/templates                # 양식 목록
GET    /api/templates/{id}           # 양식 상세
POST   /api/templates               # 양식 생성 (관리자)
PUT    /api/templates/{id}          # 양식 수정 (관리자)
DELETE /api/templates/{id}          # 양식 삭제 (관리자)
```

### 5.2 결재 요청 API
```
POST   /api/approvals               # 결재 요청 생성
GET    /api/approvals               # 결재 목록 (내가 기안한/결재할)
GET    /api/approvals/{id}          # 결재 상세
PUT    /api/approvals/{id}          # 임시저장 수정
POST   /api/approvals/{id}/submit   # 상신하기
DELETE /api/approvals/{id}          # 결재 취소/삭제
```

### 5.3 결재 처리 API
```
POST   /api/approvals/{id}/approve  # 승인
POST   /api/approvals/{id}/reject   # 반려
GET    /api/approvals/{id}/history  # 결재 이력
POST   /api/approvals/{id}/cancel   # 결재 취소
```

### 5.4 결재선 관리 API
```
GET    /api/approvals/{id}/lines    # 결재선 조회
PUT    /api/approvals/{id}/lines    # 결재선 수정
GET    /api/users/approvers         # 결재자 목록 (부서별)
```

### 5.5 파일 관리 API
```
POST   /api/approvals/{id}/files    # 첨부파일 업로드
GET    /api/approvals/{id}/files    # 첨부파일 목록
DELETE /api/files/{id}              # 첨부파일 삭제
GET    /api/files/{id}/download     # 파일 다운로드
```

### 5.6 문서번호 API
```
GET    /api/document-numbers/next   # 다음 문서번호 조회
```

## 6. 비즈니스 로직

### 6.1 결재 워크플로우
1. **기안 작성**: 
   - **템플릿 사용**: 양식 선택 → 기본 결재선 자동 설정 → 내용 작성 → 첨부파일
   - **자유 작성**: 제목/내용 직접 작성 → 결재선 수동 설정 → 첨부파일
2. **임시저장**: 작성 중 자동저장/수동저장 (DRAFT 상태)
3. **상신**: 결재선 1단계 결재자에게 알림 (SUBMITTED → IN_PROGRESS)
4. **결재 진행**: 순차/병렬 결재 처리
5. **완료**: 모든 결재 완료 시 최종 승인 (APPROVED) 또는 반려 (REJECTED)

### 6.2 결재선 처리 로직
- **순차 결재**: 이전 단계 완료 후 다음 단계 진행
- **병렬 결재**: 동일 단계 모든 결재자가 동시 결재
- **필수/선택**: 필수 결재자는 반드시 승인, 선택은 건너뛰기 가능

### 6.3 문서번호 생성 규칙
```
템플릿 사용 시: {양식프리픽스}-{년도}-{월일}-{ULID 6자리}
예시: 업무기안-2025-0821-A1B2C3

템플릿 없음: 일반결재-{년도}-{월일}-{ULID 6자리}
예시: 일반결재-2025-0821-D4E5F6
```

## 7. 서비스 레이어 설계

### 7.1 Application Services
```
application/
├── document_template_service.py    # 양식 관리
├── approval_service.py             # 결재 요청/처리
├── approval_line_service.py        # 결재선 관리
├── document_number_service.py      # 문서번호 생성
└── file_attachment_service.py      # 첨부파일 관리
```

### 7.2 Repository Interfaces
```
domain/repository/
├── document_template_repo.py
├── approval_request_repo.py
├── approval_line_repo.py
├── approval_history_repo.py
└── attached_file_repo.py
```

### 7.3 Repository Implementations
```
infra/repository/
├── document_template_repo.py
├── approval_request_repo.py
├── approval_line_repo.py
├── approval_history_repo.py
└── attached_file_repo.py
```

## 8. Controller 설계

### 8.1 API Controllers
```
interface/controller/
├── document_template_controller.py # 양식 관리 API
├── approval_controller.py          # 결재 요청/처리 API
├── approval_line_controller.py     # 결재선 관리 API
└── file_attachment_controller.py   # 첨부파일 API
```

## 9. 구현 순서

### Phase 1: 기본 구조 (1-2일)
1. ✅ common/auth.py에 Enum 추가
2. 도메인 모델 생성 (5개 모델)
3. DB 모델 생성 (5개 모델)
4. 리포지토리 인터페이스 정의

### Phase 2: 핵심 기능 (2-3일)
1. 리포지토리 구현체 작성
2. 기본 서비스 레이어 구현
3. 양식 관리 API 구현
4. 결재 요청 생성/수정 API

### Phase 3: 결재 처리 (2-3일)
1. 결재선 설정 기능
2. 결재 승인/반려 처리
3. 결재 이력 관리
4. 상태 변경 로직

### Phase 4: 파일 & 고급 기능 (2-3일)
1. 파일 업로드/다운로드
2. 문서번호 자동 생성
3. 실시간 알림 (WebSocket 확장)
4. 권한 검증 강화

### Phase 5: 통합 & 테스트 (1-2일)
1. 메인 앱에 라우터 등록
2. DI 컨테이너 설정
3. API 테스트
4. 버그 수정

## 10. 기술 스택

### 10.1 백엔드
- FastAPI: REST API
- MongoDB: 문서 데이터베이스
- Beanie: ODM
- WebSocket: 실시간 알림

### 10.2 파일 저장
- 로컬 파일시스템 또는 클라우드 스토리지
- 20MB 용량 제한
- 다양한 파일 형식 지원

### 10.3 보안
- JWT 인증 유지
- 파일 업로드 보안 검증
- XSS 방지 (HTML 콘텐츠 검증)

## 11. 초기 양식 템플릿 데이터

### 11.1 기본 양식 목록
1. **업무기안**
   - 기안제목, 기안내용, 첨부파일
   - 프리픽스: "업무기안"

2. **지출결의서(기간별)**
   - 지출항목, 금액, 기간, 사유
   - 프리픽스: "지출결의"

3. **지출결의서(예산집행)**
   - 예산항목, 집행금액, 집행사유
   - 프리픽스: "예산집행"

4. **출장신청서**
   - 출장지, 출장기간, 출장목적, 예상비용
   - 프리픽스: "출장신청"

5. **총무제의서**
   - 제의내용, 제의사유, 예상효과
   - 프리픽스: "총무제의"

## 12. 테스트 계획

### 12.1 단위 테스트
- 도메인 로직 테스트
- 서비스 레이어 테스트
- 리포지토리 테스트

### 12.2 통합 테스트
- API 엔드포인트 테스트
- 결재 워크플로우 테스트
- 파일 업로드/다운로드 테스트

### 12.3 E2E 테스트
- 전체 결재 프로세스 테스트
- 사용자 시나리오 테스트

## 13. 구현 상황 (Implementation Status)

### ✅ Phase 1: 기본 구조 (완료)
- [x] 1. common/auth.py에 전자결재용 Enum 추가 (DocumentStatus, ApprovalAction, DocumentVisibility)
- [x] 2. Pydantic BaseModel로 도메인 모델 생성 (5개 파일)
- [x] 3. Beanie Document로 데이터베이스 모델 구현 (5개 파일)
- [x] 4. 리포지토리 인터페이스 정의 (5개 파일)

### ✅ Phase 2: 핵심 기능 (완료)
- [x] 5. 리포지토리 구현체 작성 (5개 파일)
- [x] 6. 비즈니스 서비스 구현 (5개 파일)
- [x] 7. API 컨트롤러 구현 (4개 파일)
- [x] 8. 메인 앱에 라우터 등록 및 DB 모델 추가
- [x] 9. 컨테이너 DI 설정 업데이트
- [x] 10. 파일 업로드 서비스 구현

### 🔲 Phase 3: 완성도 높이기 (선택사항)
- [ ] 11. 초기 양식 템플릿 데이터 설정
- [ ] 12. Response 모델 추가 (API 응답 최적화)
- [ ] 13. 파일 업로드 디렉토리 자동 생성
- [ ] 14. 기본 테스트 데이터 생성

## 14. 현재 사용 가능한 기능

### ✅ 구현 완료된 API
**양식 관리**:
- `POST /api/templates` - 양식 생성 (관리자)
- `GET /api/templates` - 양식 목록 조회
- `GET /api/templates/{id}` - 양식 상세 조회
- `PUT /api/templates/{id}` - 양식 수정 (관리자)
- `DELETE /api/templates/{id}` - 양식 삭제 (관리자)

**결재 요청**:
- `POST /api/approvals` - 결재 요청 생성 (템플릿 사용 or 자유 작성)
- `GET /api/approvals` - 내가 기안한 결재 목록
- `GET /api/approvals/pending` - 내가 결재할 요청 목록
- `GET /api/approvals/{id}` - 결재 상세 조회
- `POST /api/approvals/{id}/submit` - 결재 요청 상신
- `POST /api/approvals/{id}/approve` - 결재 승인
- `POST /api/approvals/{id}/reject` - 결재 반려
- `POST /api/approvals/{id}/cancel` - 결재 요청 취소

**결재선 관리**:
- `GET /api/approvals/{id}/lines` - 결재선 조회
- `PUT /api/approvals/{id}/lines` - 결재선 설정
- `GET /api/approval-lines/my-pending` - 내 대기 결재 목록
- `GET /api/approval-lines/my-history` - 내 결재 이력

**파일 관리**:
- `POST /api/files/approvals/{id}` - 첨부파일 업로드
- `GET /api/files/approvals/{id}` - 첨부파일 목록
- `GET /api/files/{id}/download` - 파일 다운로드
- `DELETE /api/files/{id}` - 첨부파일 삭제

### 🎯 핵심 특징
- **템플릿 기반 + 자유 작성**: 템플릿을 사용하거나 자유롭게 결재 요청 생성
- **유연한 결재선**: 순차/병렬 결재, 필수/선택 결재자 설정
- **완전한 워크플로우**: 임시저장 → 상신 → 결재 → 완료/반려
- **파일 첨부**: 20MB 이하 다양한 형식의 파일 첨부 가능
- **권한 관리**: JWT 기반 인증, 역할별 접근 제어

## 14. 주의사항

### 14.1 기존 시스템과의 호환성
- 기존 User, Group 모델과 연동
- 기존 인증/권한 시스템 유지
- 기존 API 엔드포인트와 충돌 방지

### 14.2 성능 고려사항
- 대용량 파일 업로드 처리
- 많은 결재 요청 시 성능 최적화
- 데이터베이스 쿼리 최적화

### 14.3 보안 고려사항
- 파일 업로드 보안 검증
- 결재 권한 검증
- XSS/CSRF 방지

## 15. 확장 가능성

### 15.1 향후 추가 기능
- 결재 템플릿 복사 기능
- 결재선 즐겨찾기
- 모바일 앱 지원
- 결재 통계/리포트

### 15.2 시스템 확장
- 마이크로서비스 분리 가능성
- 클라우드 배포 고려
- API 버전 관리